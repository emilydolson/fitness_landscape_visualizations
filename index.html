<html>
<head>
	<meta charset="UTF-8">
	<title>Fitness landscapes</title>
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>

	<!-- <script src="libraries/aframe-v0.8.0.min.js"></script> -->
	<script src="libraries/stackblur.min.js"></script>
	<script src="libraries/d3.js"></script>
	<script src="libraries/aframe-heatmap3d.js"></script>
	<script src="https://cdn.rawgit.com/tizzle/aframe-orbit-controls-component/master/dist/aframe-orbit-controls-component.min.js"></script>
    <script src="libraries/surface-lines.js"></script>
	<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
	<script src="libraries/THREE.MeshLine.js"></script>
	<script src="libraries/aframe-meshline-component.js"></script>
	<script src="libraries/aframe-camera-transform-controls-component.min.js"></script>
	
	<style>
		body {
			font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
			line-height: 1.6;
			font-weight: 400;
			font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
		}
		#buttonPanel {
			width:250px;
			position: absolute;
			top: 20px;
			left: 20px;
		}
		.button {
			display: inline-block;
			height: 38px;
			padding: 0 30px;
			color: #555;
			text-align: center;
			font-size: 11px;
			font-weight: 600;
			line-height: 38px;
			letter-spacing: .1rem;
			text-transform: uppercase;
			text-decoration: none;
			white-space: nowrap;
			background-color: transparent;
			border-radius: 4px;
			border: 1px solid #bbb;
			cursor: pointer;
			box-sizing: border-box;
			color: #FFF;
			background-color: #33C3F0;
			border-color: #33C3F0;
			width: 100%;
			margin-top:20px;
		}
		.button:focus {
			color: #FFF;
			background-color: #1EAEDB;
			border-color: #1EAEDB;
		}
		</style>

	<script type=text/javascript>
		var fun4_scales = {"x":d3.scaleLinear().domain([-6, 6]).range([-1.5, 1.5]),
						   "y":d3.scaleLinear().domain([-6, 6]).range([-1.5, 1.5]),
						   "z":d3.scaleLinear().domain([-1986, 199.99998]).range([0, 1])
						  };

		var fun5_scales = {"x":d3.scaleLinear().domain([-1.9, 1.9]).range([-1.5, 1.5]),
						   "y":d3.scaleLinear().domain([-1.1, 1.1]).range([-1.5, 1.5]),
						   "z":d3.scaleLinear().domain([-5.86095, 1.031627]).range([0, 1.01])
						  };

	    var fun6_scales = {"x":d3.scaleLinear().domain([-10, 10]).range([-1.5, 1.5]),
						   "y":d3.scaleLinear().domain([-10, 10]).range([-1.5, 1.5]),
						   "z":d3.scaleLinear().domain([-210.27662470796076, 186.615794955561]).range([0, 1.01])
						  };

	    var fun7_scales = {"x":d3.scaleLinear().domain([.25, 10]).range([-1.5, 1.5]),
						   "y":d3.scaleLinear().domain([.25, 10]).range([-1.5, 1.5]),
						   "z":d3.scaleLinear().domain([-.9999982330513699, 0.999999972963692]).range([0, 1.01])
						  };

	    var fun10_scales = {"x":d3.scaleLinear().domain([0, 1]).range([-1.5, 1.5]),
						    "y":d3.scaleLinear().domain([0, 1]).range([-1.5, 1.5]),
						    "z":d3.scaleLinear().domain([-38.0, -2.0004450187892893]).range([0, 1.01])
						  };

	    var fun11_scales = {"x":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "y":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "z":d3.scaleLinear().domain([-2171.198973635492, -0.002367801442371835]).range([0, 1.01])
						  };

	    var fun12_scales = {"x":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "y":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "z":d3.scaleLinear().domain([-2049.851816104665, -0.016231402532577894]).range([0, 1.01])
						  };

	    var fun13_scales = {"x":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "y":d3.scaleLinear().domain([-5, 5]).range([-1.5, 1.5]),
						    "z":d3.scaleLinear().domain([-3636.8380518041745, -0.0015356224293130573]).range([0, 1.01])
						  };


		var x_scale = fun5_scales.x;
		var y_scale = fun5_scales.y;
		var z_scale = fun5_scales.z;

		var problem_map = {4:0, 5:1, 6:2, 12:6};
</script>

	<script type="text/javascript">
		function handleClick(fun_num){
			
			//document.getElementById('basemapEl').setAttribute('src', '#png'+region);
		} // handleClick()
	</script>


</head>
<body>

	<label> Fitness landscape:
		<select id="problem", name="problem">
			<option value="4">Himmelblau</option>
			<option value="5" selected>Six-Hump Camel Back</option>
			<option value="6">Shubert 2D</option>
			<option value="12">Composition Function 2</option>
		</select>
	</label>

	<label> Z separation:
		<input id="z_slider" type="range" min="0" max=".25" step="0.0001" value=".01">
	</label>
	
	<label> Draw lines? 
		<input id="lines_checkBox" type="checkbox">
	</label>

	<label> Draw startpoints? 
		<input id="starts_checkBox" type="checkbox">
	</label>

	<label> Draw endpoints? 
		<input id="ends_checkBox" type="checkbox">
	</label>

	<label> Elite? 
		<input id="elite_checkBox" type="checkbox">
	</label>

	<label> Selection scheme:
		<select id="selection", name="selection">
			<option value="0">Tournament</option>
			<!-- <option value="1">Lexicase</option> -->
			<option value="2">Eco-EA</option>
			<option value="4">Roulette</option>
			<option value="5">Drift</option>
		</select>
	</label>

	<label> Mutation rate:
		<select id="mut_rate", name="mut_rate">
			<option value="0.1">0.1</option>
			<option value="0.01">0.01</option>
			<option value="0.001">0.001</option>
			<option value="0.0001">0.0001</option>
			<!-- <option value="0.00001">0.00001</option> -->
			<!-- <option value="0.000001">0.000001</option> -->
		</select>
	</label>

	<label> Tournament size:
		<select id="tour_size", name="tour_size">
			<option value="2">2</option>
			<option value="4">4</option>
			<option value="8">8</option>
			<option value="16">16</option>
		</select>
	</label>


	<label> Number of lineage paths to draw:
		<select id="n_lineages", name="n_lineages">
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
		</select>
	</label>

	<!-- <label> Epsilon:
		<select id="epsilon", name="epsilon">
			<option value="0">0</option>
			<option value="0.01">0.01</option>
			<option value="1e-09">1e-09</option>
			<option value="1e-12">1e-12</option>
		</select>
	</label> -->

	<button type="button" onclick="load_data()">Redraw</button>

	<script type="text/javascript">
		document.addEventListener('DOMContentLoaded',function() {
			document.querySelector('select[name="problem"]').onchange=problemChangeEventHandler;	
		},false);

		function problemChangeEventHandler(event) {
			
			if(!event.target.value) return;
			else {
				console.log('Switch to '+event.target.value);
				document.getElementById('middle').setAttribute('aframe-heatmap3d', {
					src: '#fun' + event.target.value, srcMobile: '#fun' + event.target.value});
				d3.select('#basemapEl').transition().attr('src','#fun'+event.target.value);
				x_scale = window["fun"+event.target.value+"_scales"].x
				y_scale = window["fun"+event.target.value+"_scales"].y
				z_scale = window["fun"+event.target.value+"_scales"].z
				load_data();
			} 
		}

		function load_data() {
			// console.log("loading data");
			z_scale.range([0,1.01]);
			var lines = document.querySelectorAll("[dataline]");
			for (var i = 0; i < lines.length; i++) {
				lines[i].parentNode.removeChild(lines[i]);
			}

			var spheres = document.querySelectorAll("a-sphere");
			for (var i = 0; i < spheres.length; i++) {
				spheres[i].parentNode.removeChild(spheres[i]);
			}

			var selection = document.querySelector('select[name="selection"]').value;
			var problem = problem_map[document.querySelector('select[name="problem"]').value];

			d3.csv("P"+problem+"S"+selection+".csv", function(error, data) {
				if (error){
					throw error;
				}
				console.log("loaded data");
				// var epsilon = document.querySelector('select[name="epsilon"]').value;
				var tour_size = document.querySelector('select[name="tour_size"]').value;
				var mut_rate = document.querySelector('select[name="mut_rate"]').value;
				var elite = document.querySelector('#elite_checkbox').checked;
				var n_lineages = +document.querySelector('#n_lineages').value;
				// console.log(tour_size, mut_rate, selection, problem);
				var i = 0;
				// var seeds = [];
				for (line of data){
					// console.log(line);
					if (line.SELECTION_METHOD == selection && 
					(line.TOURNAMENT_SIZE == tour_size || selection != "0") &&
					// (line.LEXICASE_EPSILON == epsilon || selection != "1") &&
					line.MUTATION_STD == mut_rate && line.PROBLEM == problem &&
					(line.ELITE_SELECT__ELITE_CNT == +elite)) {
							// if (i==1) {
							// console.log(line.RANDOM_SEED);
							// if (!seeds.includes(line.RANDOM_SEED)) {
								// console.log(seeds);
								// console.log("drawing");
								draw_lineage(line.path);
								// seeds.push(line.RANDOM_SEED);
								i++;
								if (i >= n_lineages) {
									break;
								}
							// }

							
							
					}
				}

			});				
		}

	</script>

	<a-scene id="scene" camera-transform-controls="">

		<a-assets>
			<img id="fun4" src="data/fun_4.jpg"  style="display:none"/>
			<img id="fun5" src="data/fun_5.jpg"  style="display:none"/>
			<img id="fun6" src="data/fun_6.jpg"  style="display:none"/>
			<img id="fun7" src="data/fun_7.jpg"  style="display:none"/>
			<img id="fun10" src="data/fun_10.jpg"  style="display:none"/>
			<img id="fun11" src="data/fun_11.jpg"  style="display:none"/>
			<img id="fun12" src="data/fun_12.jpg"  style="display:none"/>
			<img id="fun13" src="data/fun_13.jpg"  style="display:none"/>

		</a-assets>

		<a-entity	
		id="middle"
		aframe-heatmap3d="
		src: #fun5;
		srcMobile: #fun5;
		ignoreZeroValues:false; 
		invertElevation:true;
		palette:parula;
		metalness:.5;
		roughness:0;
		stackBlurRadius:1;		
		stretch:true;
		flipPalette:false; 
		renderMode: surface;
		scaleOpacity: false;
		scaleOpacityMethod:log2;
		opacityMin: 0.99; 
		 width: 3; height: 3;" scale="1 1 1">
		</a-entity>		

		<a-entity
			id="target"
			geometry="primitive: box"
			position="0 0 0"
			material="visible:false">

		</a-entity>

		<a-entity daydream-controls></a-entity>

		<!-- Default lighting injected by A-Frame. -		-->
		<!-- <a-entity light="type: ambient; color: #fff"></a-entity> -->

		<a-entity light="type: directional; target: middle; color: #FFF; intensity: 0.5" position="2 4 5"></a-entity>
		<a-entity light="intensity: 2; distance: 1; angle: 90; target: middle; type:directional" position="5 5 3"></a-entity>

        <a-entity id="cameraRig">
            <!-- camera -->
			<a-entity
			camera="active:true; spectator:true"
			id="camera_orbit"
			position="0 2 3"
			look-controls
			wasd-controls="fly:true"
			orbit-controls="
			autoRotate: false;
			target: #target;
			enableDamping: true;
			dampingFactor: 0.125;
			rotateSpeed:0.15;
			zoomSpeed:0.5;
			maxPolarAngle:1.85;
			minDistance:1;
			maxDistance:10;
			autoVRLookCam: false;">
			</a-entity>
            <a-entity id="lefthand" camera-transform-controls-hand="hand:left" vive-controls="hand: left" oculus-touch-controls="hand: left" windows-motion-controls="hand: left"></a-entity>
            <a-entity id="righthand" camera-transform-controls-hand="hand:right" vive-controls="hand: right" oculus-touch-controls="hand: right" windows-motion-controls="hand: right"></a-entity>
        </a-entity>

		<!-- <a-entity id="lines">

		</a-entity> -->
		<!-- <a-entity dataline = "path:-.5 -.5 -4, .5 .5 1, .5 -.5 0;" ></a-entity> -->
		<script>

			var draw_lineage = function(data){
					// var scene = d3.select("#scene");
					// scene.selectAll("a-entity")
					// console.log("logging data", data);
					// var ssv = d3.dsvFormat(" ");
		
					// var points = data.split(",");
					// // console.log("ponts:", points);
					// // points = points.map(ssv.parse);
					// // console.log("ponts:", points, ssv.parse);
					// points = points.map(x => {
					// 	x = x.split(" "); 
					// 	return [x_scale(x[0]), z_scale(x[2]), y_scale(x[1])];
					// });
		
					
					// data_to_bind = [];
					// for (var i = 0; i < points.length-1; i++) {
					// 	// var v = ssv.parse(points[i]);
					// 	data_to_bind.push({"start": points[i], "end":points[i+1], "color": d3.hsl(0, 0, i/data_to_bind.length)});
					// }
					// // console.log(data_to_bind);
					var sceneEl = document.querySelector('a-scene');

					if (document.querySelector('#starts_checkbox').checked) {
						var startSphereEl = document.createElement('a-sphere');
						var startpos = data.slice(data.lastIndexOf(",")+1, data.length).split(" ");
						startpos[0] = x_scale(startpos[0]);
						var y = y_scale(startpos[1]);
						var z = z_scale(startpos[2]);
						startpos[1] = z;
						startpos[2] = y;

						startSphereEl.setAttribute("position", startpos.join(" "));
						startSphereEl.setAttribute("radius", .01);
						sceneEl.appendChild(startSphereEl);
					}

					if (document.querySelector('#ends_checkbox').checked) {
						var endSphereEl = document.createElement('a-sphere');
						var endpos = data.slice(0,data.indexOf(",")).split(" ");

						endpos[0] = x_scale(endpos[0]);
						y = y_scale(endpos[1]);
						z = z_scale(endpos[2]);
						endpos[1] = z;
						endpos[2] = y;

						endSphereEl.setAttribute("position", endpos.join(" "));
						endSphereEl.setAttribute("radius", .01);
						endSphereEl.setAttribute("material", "color", "black");
						sceneEl.appendChild(endSphereEl);
					}
					// console.log(data)
					if (document.querySelector('#lines_checkbox').checked) {
						var lineEl = document.createElement('a-entity');
						lineEl.setAttribute("dataline", {"path": data, "z_increment":document.querySelector('#z_slider').value});
						sceneEl.appendChild(lineEl);
					}

					// lineEl.setAttribute("dataline", "z_increment", .1);

					// for (var i = 0; i < 1023; i++) {
					// 	// console.log(i, data_to_bind[i]);
					// 	// entityEl.setAttribute("line__"+i, "start", "0, 0, 0");
					// 	entityEl.setAttribute("line__"+i.toString(), data_to_bind[i]);

					// }
					


					// d3.select("#lines").append("a-entity")
					// 				   .selectAll("a-entity")
					// 				   .data(data_to_bind)
					// 				   .enter()
					// 				   .append("a-entity")
					// 				   .attr("line", function(d,i){return "start: " + d.start.join(", ") + "; end: " + d.end.join(", ")+"; color: "+d3.hsl(0, 0, i/data_to_bind.length);});
									//    .attr("meshline", "lineWidth:10; color:red; path:"+ data);
			};

			load_data();		
		</script>

	</a-scene>


</body>

</html>
